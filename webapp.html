<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>–°–∫–∞–Ω–µ—Ä —à—Ç—Ä–∏—Ö–∫–æ–¥–∞</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <script src="https://unpkg.com/@zxing/library@0.21.2/umd/index.min.js"></script>
  <style>
    body { 
      font-family: system-ui, Arial; 
      margin: 0;
      padding: 16px;
      background: var(--tg-theme-bg-color, #fff);
      color: var(--tg-theme-text-color, #000);
    }
    h2 { margin: 0 0 10px; }
    #video { 
      width: 100%; 
      max-width: 520px; 
      border-radius: 12px; 
      background: #000; 
      display: block;
      margin: 0 auto;
    }
    .row { 
      margin-top: 12px; 
      display: flex; 
      gap: 10px; 
      flex-wrap: wrap; 
      justify-content: center;
    }
    button, input {
      padding: 12px 14px; 
      border-radius: 12px; 
      border: 1px solid #ddd; 
      background: var(--tg-theme-button-color, #3390ec);
      color: var(--tg-theme-button-text-color, #fff);
      font-size: 16px;
      cursor: pointer;
      font-weight: 500;
    }
    button:active {
      opacity: 0.8;
    }
    input { 
      flex: 1; 
      min-width: 220px;
      background: var(--tg-theme-bg-color, #fff);
      color: var(--tg-theme-text-color, #000);
    }
    .hint { 
      color: var(--tg-theme-hint-color, #999); 
      margin-top: 10px; 
      line-height: 1.35;
      text-align: center;
      font-size: 14px;
    }
    .code { 
      font-size: 24px; 
      font-weight: 700; 
      margin-top: 15px; 
      word-break: break-all;
      text-align: center;
      padding: 15px;
      background: var(--tg-theme-secondary-bg-color, #f0f0f0);
      border-radius: 12px;
    }
    .status { 
      margin-top: 10px; 
      color: var(--tg-theme-text-color, #333);
      text-align: center;
      font-weight: 500;
    }
    .success { color: #4CAF50; }
    .error { color: #f44336; }
    .warning { color: #ff9800; }
    .confirm-buttons {
      display: none;
      gap: 10px;
      margin-top: 10px;
    }
    .confirm-buttons.show {
      display: flex;
    }
    .btn-success {
      background: #4CAF50;
      flex: 1;
    }
    .btn-danger {
      background: #f44336;
      flex: 1;
    }
  </style>
</head>
<body>
  <h2 style="text-align: center;">üì∑ –°–∫–∞–Ω–µ—Ä —à—Ç—Ä–∏—Ö–∫–æ–¥–∞</h2>

  <video id="video" playsinline></video>

  <div class="row">
    <button id="startBtn">‚ñ∂Ô∏è –°—Ç–∞—Ä—Ç</button>
    <button id="stopBtn">‚èπ –°—Ç–æ–ø</button>
  </div>

  <div class="status" id="status">–ù–∞–∂–º–∏ ‚ñ∂Ô∏è –°—Ç–∞—Ä—Ç –¥–ª—è —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è</div>
  <div class="code" id="lastCode" style="display: none;"></div>
  
  <div class="row confirm-buttons" id="confirmButtons">
    <button class="btn-success" id="confirmBtn">‚úÖ –í–µ—Ä–Ω–æ</button>
    <button class="btn-danger" id="rejectBtn">‚ùå –ù–µ–≤–µ—Ä–Ω–æ</button>
  </div>

  <div class="row">
    <input id="manual" placeholder="–ò–ª–∏ –≤–≤–µ–¥–∏—Ç–µ –∫–æ–¥ –≤—Ä—É—á–Ω—É—é" inputmode="numeric" />
    <button id="sendBtn">üì§ –û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
  </div>

  <div class="hint">
    –ù–∞–≤–µ–¥–∏—Ç–µ –∫–∞–º–µ—Ä—É –Ω–∞ —à—Ç—Ä–∏—Ö–∫–æ–¥.<br>
    EAN-13 –¥–æ–ª–∂–µ–Ω —Å–æ–¥–µ—Ä–∂–∞—Ç—å 13 —Ü–∏—Ñ—Ä.<br>
    –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∫–æ–¥ –ø–µ—Ä–µ–¥ –æ—Ç–ø—Ä–∞–≤–∫–æ–π!
  </div>

  <script>
    const tg = window.Telegram?.WebApp;
    if (tg) {
      tg.ready();
      tg.expand();
    }

    const video = document.getElementById("video");
    const lastCodeEl = document.getElementById("lastCode");
    const statusEl = document.getElementById("status");
    const startBtn = document.getElementById("startBtn");
    const stopBtn = document.getElementById("stopBtn");
    const manual = document.getElementById("manual");
    const sendBtn = document.getElementById("sendBtn");
    const confirmButtons = document.getElementById("confirmButtons");
    const confirmBtn = document.getElementById("confirmBtn");
    const rejectBtn = document.getElementById("rejectBtn");

    const codeReader = new ZXing.BrowserMultiFormatReader();
    let controls = null;
    let lastScannedCode = null;
    let scanCount = {};

    function onlyDigits(s) {
      return (s || "").replace(/\D/g, "");
    }

    function isValidEAN13(code) {
      return code.length === 13;
    }

    function showCode(code, isValid) {
      lastCodeEl.textContent = code;
      lastCodeEl.style.display = 'block';
      
      if (isValid) {
        lastCodeEl.style.borderLeft = '4px solid #4CAF50';
      } else {
        lastCodeEl.style.borderLeft = '4px solid #ff9800';
      }
    }

    function hideCode() {
      lastCodeEl.style.display = 'none';
      confirmButtons.classList.remove('show');
    }

    function sendToBot(code) {
      const digits = onlyDigits(code);
      if (!digits || digits.length < 4) {
        statusEl.className = "status error";
        statusEl.textContent = "‚ùå –ö–æ–¥ –¥–æ–ª–∂–µ–Ω —Å–æ–¥–µ—Ä–∂–∞—Ç—å –º–∏–Ω–∏–º—É–º 4 —Ü–∏—Ñ—Ä—ã";
        return;
      }
      
      statusEl.className = "status success";
      statusEl.textContent = "‚úÖ –û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ –≤ –±–æ—Ç...";

      if (tg && tg.sendData) {
        tg.sendData(digits);
        setTimeout(() => {
          if (tg.close) tg.close();
        }, 500);
      } else {
        statusEl.className = "status error";
        statusEl.textContent = "‚ùå –û—Ç–∫—Ä–æ–π—Ç–µ —á–µ—Ä–µ–∑ –∫–Ω–æ–ø–∫—É –≤ –±–æ—Ç–µ";
      }
    }

    function handleScannedCode(code) {
      const digits = onlyDigits(code);
      
      if (digits.length < 8) {
        return; // –ò–≥–Ω–æ—Ä–∏—Ä—É–µ–º —Å–ª–∏—à–∫–æ–º –∫–æ—Ä–æ—Ç–∫–∏–µ –∫–æ–¥—ã
      }

      // –ü–æ–¥—Å—á–µ—Ç –ø–æ–≤—Ç–æ—Ä–µ–Ω–∏–π
      scanCount[digits] = (scanCount[digits] || 0) + 1;

      // –ï—Å–ª–∏ –∫–æ–¥ –æ—Ç—Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω 2+ —Ä–∞–∑–∞ - —Å–∫–æ—Ä–µ–µ –≤—Å–µ–≥–æ –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π
      if (scanCount[digits] >= 2) {
        const isValid = isValidEAN13(digits);
        
        if (isValid) {
          statusEl.className = "status success";
          statusEl.textContent = `‚úÖ –ö–æ–¥ —Ä–∞—Å–ø–æ–∑–Ω–∞–Ω: ${digits}`;
          showCode(digits, true);
          
          // –ê–≤—Ç–æ–æ—Ç–ø—Ä–∞–≤–∫–∞ –¥–ª—è –≤–∞–ª–∏–¥–Ω—ã—Ö EAN-13
          setTimeout(() => sendToBot(digits), 1000);
          
          try { if (controls) controls.stop(); } catch(e) {}
        } else {
          statusEl.className = "status warning";
          statusEl.textContent = `‚ö†Ô∏è –ö–æ–¥: ${digits} (–Ω–µ EAN-13). –ü—Ä–æ–≤–µ—Ä—å—Ç–µ!`;
          showCode(digits, false);
          confirmButtons.classList.add('show');
          lastScannedCode = digits;
          
          try { if (controls) controls.stop(); } catch(e) {}
        }
        
        scanCount = {}; // –°–±—Ä–æ—Å —Å—á–µ—Ç—á–∏–∫–∞
      } else {
        statusEl.className = "status";
        statusEl.textContent = `–°–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ... (${digits.slice(0, 8)}...)`;
      }
    }

    async function startScan() {
      hideCode();
      scanCount = {};
      statusEl.className = "status";
      statusEl.textContent = "–ó–∞–ø—É—Å–∫ –∫–∞–º–µ—Ä—ã‚Ä¶";
      
      try {
        controls = await codeReader.decodeFromVideoDevice(
          null,
          video,
          (result, err, c) => {
            if (result) {
              const text = (result.getText() || "").trim();
              handleScannedCode(text);
            }
          }
        );
        statusEl.className = "status";
        statusEl.textContent = "üì∑ –ù–∞–≤–µ–¥–∏—Ç–µ –Ω–∞ —à—Ç—Ä–∏—Ö–∫–æ–¥";
      } catch (e) {
        statusEl.className = "status error";
        statusEl.textContent = "‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–∫—Ä—ã—Ç—å –∫–∞–º–µ—Ä—É";
        console.error(e);
      }
    }

    function stopScan() {
      try { if (controls) controls.stop(); } catch(e) {}
      controls = null;
      scanCount = {};
      statusEl.className = "status";
      statusEl.textContent = "‚èπ –°–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ";
    }

    startBtn.addEventListener("click", startScan);
    stopBtn.addEventListener("click", stopScan);

    confirmBtn.addEventListener("click", () => {
      if (lastScannedCode) {
        sendToBot(lastScannedCode);
      }
    });

    rejectBtn.addEventListener("click", () => {
      hideCode();
      lastScannedCode = null;
      startScan(); // –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è
    });

    sendBtn.addEventListener("click", () => sendToBot(manual.value));
    manual.addEventListener("keydown", (e) => {
      if (e.key === "Enter") sendToBot(manual.value);
    });

    if (tg && tg.BackButton) {
      tg.BackButton.show();
      tg.BackButton.onClick(() => {
        stopScan();
        tg.close();
      });
    }
  </script>
</body>
</html>
