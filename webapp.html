<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>–°–∫–∞–Ω–µ—Ä —à—Ç—Ä–∏—Ö–∫–æ–¥–∞</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <script src="https://unpkg.com/@zxing/library@0.21.2/umd/index.min.js"></script>
  <style>
    body { font-family: system-ui, Arial; margin: 16px; }
    h2 { margin: 0 0 10px; }
    #video { width: 100%; max-width: 520px; border-radius: 12px; background: #000; }
    .row { margin-top: 12px; display: flex; gap: 10px; flex-wrap: wrap; }
    button, input {
      padding: 12px 14px; border-radius: 12px; border: 1px solid #ddd; background: #fff;
      font-size: 16px;
    }
    input { flex: 1; min-width: 220px; }
    .hint { color: #555; margin-top: 10px; line-height: 1.35; }
    .code { font-size: 18px; font-weight: 700; margin-top: 10px; word-break: break-all; }
    .status { margin-top: 10px; color: #333; }
  </style>
</head>
<body>
  <h2>üì∑ –°–∫–∞–Ω–µ—Ä —à—Ç—Ä–∏—Ö–∫–æ–¥–∞</h2>

  <video id="video" playsinline></video>

  <div class="row">
    <button id="startBtn">‚ñ∂Ô∏è –°—Ç–∞—Ä—Ç</button>
    <button id="stopBtn">‚èπ –°—Ç–æ–ø</button>
  </div>

  <div class="row">
    <input id="manual" placeholder="–ï—Å–ª–∏ –∫–∞–º–µ—Ä–∞ –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç ‚Äî –≤—Å—Ç–∞–≤—å EAN/SAP" inputmode="numeric" />
    <button id="sendBtn">üì§ –û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
  </div>

  <div class="hint">
    –ù–∞–≤–µ–¥–∏ –∫–∞–º–µ—Ä—É –Ω–∞ —à—Ç—Ä–∏—Ö–∫–æ–¥. –ü–æ—Å–ª–µ —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏—è –∫–æ–¥ –æ—Ç–ø—Ä–∞–≤–∏—Ç—Å—è –≤ –±–æ—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏.<br>
    –ï—Å–ª–∏ –∫–∞–º–µ—Ä–∞ –Ω–µ –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç—Å—è ‚Äî —Ä–∞–∑—Ä–µ—à–∏ –¥–æ—Å—Ç—É–ø –∫ –∫–∞–º–µ—Ä–µ –∏–ª–∏ –≤–æ—Å–ø–æ–ª—å–∑—É–π—Å—è —Ä—É—á–Ω—ã–º –≤–≤–æ–¥–æ–º.
  </div>

  <div class="status" id="status"></div>
  <div class="code" id="lastCode"></div>

  <script>
    const tg = window.Telegram?.WebApp;
    if (tg) tg.ready();

    const video = document.getElementById("video");
    const lastCode = document.getElementById("lastCode");
    const statusEl = document.getElementById("status");
    const startBtn = document.getElementById("startBtn");
    const stopBtn = document.getElementById("stopBtn");
    const manual = document.getElementById("manual");
    const sendBtn = document.getElementById("sendBtn");

    const codeReader = new ZXing.BrowserMultiFormatReader();
    let controls = null;

    function onlyDigits(s) {
      return (s || "").replace(/\D/g, "");
    }

    function sendToBot(code) {
      const digits = onlyDigits(code);
      if (!digits || digits.length < 4) {
        statusEl.textContent = "‚ùå –í–≤–µ–¥–∏ –∫–æ–¥ (—Ç–æ–ª—å–∫–æ —Ü–∏—Ñ—Ä—ã).";
        return;
      }
      lastCode.textContent = "‚úÖ " + digits;
      statusEl.textContent = "–û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ –≤ –±–æ—Ç‚Ä¶";

      if (tg && tg.sendData) {
        tg.sendData(digits);
      } else {
        alert("Telegram WebApp API –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω. –û—Ç–∫—Ä–æ–π —á–µ—Ä–µ–∑ –∫–Ω–æ–ø–∫—É –≤ –±–æ—Ç–µ.");
      }
    }

    async function startScan() {
      statusEl.textContent = "–ó–∞–ø—É—Å–∫ –∫–∞–º–µ—Ä—ã‚Ä¶";
      try {
        controls = await codeReader.decodeFromVideoDevice(
          null,
          video,
          (result, err, c) => {
            if (result) {
              const text = (result.getText() || "").trim();
              const digits = onlyDigits(text);
              if (digits.length >= 8) {
                try { c.stop(); } catch(e) {}
                statusEl.textContent = "–ö–æ–¥ —Ä–∞—Å–ø–æ–∑–Ω–∞–Ω ‚úÖ";
                sendToBot(digits);
              }
            }
          }
        );
        statusEl.textContent = "–ö–∞–º–µ—Ä–∞ –∑–∞–ø—É—â–µ–Ω–∞. –ù–∞–≤–µ–¥–∏ –Ω–∞ —à—Ç—Ä–∏—Ö–∫–æ–¥.";
      } catch (e) {
        statusEl.textContent = "‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–∫—Ä—ã—Ç—å –∫–∞–º–µ—Ä—É. –†–∞–∑—Ä–µ—à–∏ –¥–æ—Å—Ç—É–ø –∫ –∫–∞–º–µ—Ä–µ –∏–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–π —Ä—É—á–Ω–æ–π –≤–≤–æ–¥.";
        console.error(e);
      }
    }

    function stopScan() {
      try { if (controls) controls.stop(); } catch(e) {}
      controls = null;
      statusEl.textContent = "–°–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ.";
    }

    startBtn.addEventListener("click", startScan);
    stopBtn.addEventListener("click", stopScan);

    sendBtn.addEventListener("click", () => sendToBot(manual.value));
    manual.addEventListener("keydown", (e) => {
      if (e.key === "Enter") sendToBot(manual.value);
    });

    // –ù–µ –∞–≤—Ç–æ–∑–∞–ø—É—Å–∫–∞–µ–º –∫–∞–º–µ—Ä—É ‚Äî –≤ –Ω–µ–∫–æ—Ç–æ—Ä—ã—Ö —Ç–µ–ª–µ—Ñ–æ–Ω–∞—Ö –±–ª–æ–∫–∏—Ä—É–µ—Ç—Å—è –±–µ–∑ –∫–ª–∏–∫–∞
    statusEl.textContent = "–ù–∞–∂–º–∏ ‚ñ∂Ô∏è –°—Ç–∞—Ä—Ç, —á—Ç–æ–±—ã –≤–∫–ª—é—á–∏—Ç—å –∫–∞–º–µ—Ä—É.";
  </script>
</body>
</html>
